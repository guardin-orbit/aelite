<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>JWT Client with Auto Token Refresh</title>
</head>
<body>
    <h1>JWT Authentication Client</h1>

    <h2>Register</h2>
    <input id="reg-username" placeholder="Username" /><br />
    <input id="reg-password" placeholder="Password" type="password" /><br />
    <button onclick="register()">Register</button>

    <hr />

    <h2>Login</h2>
    <input id="login-username" placeholder="Username" value="admin" /><br />
    <input id="login-password" placeholder="Password" type="password" value="password" /><br />
    <button onclick="login()">Login</button>

    <hr />

    <button onclick="getProtected()">GET Protected Data</button>

    <pre id="output"></pre>

    <script>
        let accessToken = localStorage.getItem("accessToken") || "";
        let refreshToken = localStorage.getItem("refreshToken") || "";

        async function register() {
            const username = document.getElementById("reg-username").value;
            const password = document.getElementById("reg-password").value;

            const res = await fetch("/api/v1/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json();
            if (res.ok) {
                alert("Registration successful! You can now log in.");
            } else {
                alert("Registration failed: " + (data.detail || JSON.stringify(data)));
            }
        }

        async function login() {
            const username = document.getElementById("login-username").value;
            const password = document.getElementById("login-password").value;

            const res = await fetch("/api/v1/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json();
            if (res.ok) {
                accessToken = data.access_token;
                refreshToken = data.refresh_token;
                localStorage.setItem("accessToken", accessToken);
                localStorage.setItem("refreshToken", refreshToken);
                alert("Logged in!");
            } else {
                alert("Login failed: " + (data.detail || JSON.stringify(data)));
            }
        }

        // Функция для автоматического обновления access токена
        async function refreshAccessToken() {
            if (!refreshToken) {
                alert("No refresh token available. Please log in first.");
                return false;
            }

            const res = await fetch("/refresh", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            const data = await res.json();
            if (res.ok) {
                accessToken = data.access_token;
                localStorage.setItem("accessToken", accessToken);
                return true;
            } else {
                alert("Refresh failed: " + (data.detail || JSON.stringify(data)));
                return false;
            }
        }

        // Обёртка для fetch, которая автоматически обновляет токен при 401
        async function fetchWithAuth(url, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers["Authorization"] = "Bearer " + accessToken;

            let res = await fetch(url, options);
            if (res.status === 401) {
                // Попытка обновить токен
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    // Повторяем запрос с новым токеном
                    options.headers["Authorization"] = "Bearer " + accessToken;
                    res = await fetch(url, options);
                }
            }
            return res;
        }

        async function getProtected() {
            if (!accessToken) {
                alert("You need to log in first.");
                return;
            }

            const res = await fetchWithAuth("/protected");
            const data = await res.json();
            if (res.ok) {
                document.getElementById("output").textContent = JSON.stringify(data, null, 2);
            } else {
                alert("Failed to fetch protected data: " + (data.detail || JSON.stringify(data)));
            }
        }
    </script>
</body>
</html>
